# Конфигурация Wireguard VPN
В текущей работе будет рассмотрена деятельность по установке соединения VPN WireGuard на платформе Mikrotik RouterOS 7.3.1. Ранее данная конфигурация была недоступна, однако выпуск версии программного обеспечения ***7.3.1*** позволил организовать соответствующий туннель в данной операционной системе. Преимущества механизма подключения WireGuard заключаются в следующих особенностях:

- UDP соединение;
- Проходимость через NAT;
- Гибкое управление интерфейсами;

Из минусов — это отсутствие сохранения состояния и ручное назначение адресов на интерфейсы, как клиентские, так и серверные. Да, тут стоит оговориться, что это не клиент-серверная технология, в понятии протокола есть Peer, который может как принимать соединения, так и инициировать.
> То есть тут нет настройки wireguard server и client как в привычных VPN протоколах на MikroTik. В данном случае оба конца сети равнозначны.
Общая идеология строится на том, что у обоих пиров есть приватный и публичные ключи. Это обычная строка цифр и символов сгенерированная в BASE64 кодировке. Всякий раз, когда вы создаёте WireGuard интерфейс, генерируется случайная последовательность ключа. Приватный ключ никому передавать нельзя, а вот публичный нужен для настройки с двух сторон. Первой стороне нужен ключ со второй стороны, и наоборот, второй стороне нужен ключ первой.
Т.е. простыми словами, у вас нет логина и пароля. Все обоюдно, шифруется публичными ключами каждой из сторон. Давайте перейдём от слов к делу и посмотрим на схему сети.

Поскольку ранее вы использовали версии CHR ниже требуемой (с поддержкой WireGuard), то требуется обновить виртуальные машины до актуальной версии ПО, сделать этом можно перейдя в графу System -> Packages -> Check for Updates. После установки обновлений через эту оснастку требуется обновить и ПО самого маршрутизатора через меню System -> Routerboard -> Upgrade.
При обновлении на роутере должен быть доступ к Интернету и наличие свободного места на жестком диске. Если со вторым проблем возникнуть почти не может, то с первым нужно заранее убедиться, что сетевая карта маршрутизатора настроена как NAT или сетевой мост (мост предпочтительней).

## Схема сети
В нашем случае  имеется провайдер со своей сетью, внутри которой мы будем и настраивать туннель. И далее внутри него, настроим маршрутизацию между площадками.
Такую схему можно собрать на виртуальных машинах, тогда, в случае использования Virtualbox, требуется эмулировать работу двух компьютеров и отдельных подсетей. Виртуальные адаптеры хоста №1 и №2 для соединений пк1 и пк2 соответственно, такие-же параметры на ether2 для office-1 и office-2. На eth1 для office-1 следует выбрать тип соединения "внутренняя сеть", аналогично для office-2. При этом они должны находиться в двух разных внутренних сетях с разной адресацией. ISP подключается также к двум настроенным внутренним сетям.
Схему также можно собрать и в GNS3, но в этом случае не будет возможности открыть WinBox напрямую и настройка будет производиться в терминале или в web-интерфейсе маршрутизатора.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Wireguard-shema-seti.jpg)

## Настройка Office-1
Открываем меню WireGuard и создаём интерфейс. Имя можно задать какое угодно, в примере указано направление отправки пакетов.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Sozdanie-pervogo-WireGuard-v-Office-1.png.jpg)

Listen Port можете поменять, а можете оставить по умолчанию. Нажимаем применить и видим наш Private и Public.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Prosmotr-publichnogo-i-privatnogo-klyucha-WireGuard-1.jpg)

Далее переходим на вкладку Peers и создаём пира. Нам нужно указать:

- На каком интерфейсе будет слушаться подключение;
- Публичный ключ другой стороны;
- Endpoint – публичный IP партнёра;
- Endpoint Port – соответственно его порт;
- Allowed Address – сети и адреса, которым разрешено «бегать» по коридору, т.е. через данный интерфейс.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Sozdanie-peer-v-ofise-1-1.jpg)

Далеко не отходим, и подключаемся к Office-2. Здесь так же создаём peer с понятным именем в сторону первого офиса.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Sozdanie-vtorogo-WireGuard-v-Office-2.png.jpg)

Копируем Public Key с Office-2 и возвращаемся в Office-1 и вставляем в настройки пира.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Konfigurirovanie-Public-Key-mezhdu-Mikrotik.jpg)

На этом же девайсе (Office-1), задаём IP на WireGuard to-Office-2 172.16.30.1 – это адрес внутри VPN сети.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Naznachenie-IP-adresa-na-WireGuard-v-ofise-1.jpg)

Далее нам нужно создать peer на втором роутере. Копируем публичный ключ первого и переходим к настройке. Все аналогично, но только зеркально.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Konfigurirovanie-shifrovaniya-WireGuard.jpg)

- Public Key – публичный ключ партнёра, т.е. первого роутера;
- Его публичный IP и порт;
- Разрешённые адреса, и сети.
- Сохраняем, применяем и не забываем назначить туннельный IP на Office-2.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/IP-adres-na-WireGuard-v-ofise-2.jpg)


## Проверка WireGuard
Запустим ping по туннельным адресам wireguard в направлении друг друга c двух микротиков.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Proverka-rabotosposobnosti-WireGuard.jpg)

Обратите внимание на интерфейсы, трафик действительно идёт по нужным.

## Маршрутизация
Остаётся создание маршрутов в соседние сети. Выше мы убедились, что WireGuard работает, остаётся научить наши маршрутизаторы ходить друг к другу.

Создаём маршрут во второй офис на первом mikrotik через раздел routes (а не через wireguard).

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Nastraivaem-marshrutizatsiyu-WireGuard.jpg)

И наоборот, во втором офисе создаём маршрут в первый.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Immediate-Gateway-v-WireGuard.jpg)

Обратите внимание на Immediate Gateway – после сохранения правила, интерфейс через который доступна сеть, Mikrotik подставит автоматически. Ваша задача проверить, чтобы был выбран верный.

## Проверка связанности сетей
Для этого включаем наши виртуальный PCs, проверяем чтобы мы получили адреса корректные и пробуем прошпиговать друг друга.

![](https://mikrotiklab.ru/wp-content/uploads/2022/07/Site-to-site-VPN-WireGuard.jpg)

На этом шаге VPN должен работать в полном объеме. Далее вы можете ограничивать трафик на уровне фаервола, но в этой работе не требуется таких действий.

Подытожим, мы настроили WireGuard на двух роутерах MikroTik, объяснили что в данной технологии нет привычной клиент серверной архитектуры, создали маршруты и объединили два офиса (site to site). 
